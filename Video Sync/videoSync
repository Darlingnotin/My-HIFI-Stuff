<!doctype html>
<html>

<head>
    <title>HIFI Video Sync</title>
</head>

<body>
    <style>
        #video-container {
            width: 100%;
            height: auto;
        }

        #v1 {
            float: 100%;
            width: 100%;
            height: auto;
        }
    </style>
    <button onclick="chooseVideo()" type="button">Choose Video</button>
    <button onclick="sync()" type="button">Sync</button><br>
    <div id="video-container">
        <video id="v1" controls autoplay>
            <source id="mp4_src" src=" " type="video/webm">
        </video>
    </div>

    <script language="JavaScript" type="text/javascript">

        var firstPlay = true;
        window.onload = function () {
            var v1 = document.getElementById('v1');

            v1.addEventListener("play", function () {
                if (firstPlay == true) {
                    firstPlay = false;
                } else {
                    play();
                }
            });

            v1.addEventListener("pause", function () {
                pause();
            });

            v1.addEventListener("seeking", function () {
            });

            v1.addEventListener("seeked", function () {
            });

            var syncbutton = document.getElementById('sync2vid');
        }


        var n;
        var timeStamp;

        function play() {
            console.log("document ready");
            n = Date.now();
            var readyEvent = {
                "action": "play",
                "timeStamp": v1.currentTime,
                "videoUrl": person,
                "nowVideo": "false",
                "check": n
            };
            EventBridge.emitWebEvent(JSON.stringify(readyEvent));
            $(".gemstone-button").click(function () {
                console.log(this.value + " button click");
                var clickEvent = {
                    "type": "click",
                    "data": this.value
                };
                EventBridge.emitWebEvent(JSON.stringify(clickEvent));
            });
        }

        function pause() {
            console.log("document ready");
            n = Date.now();
            var readyEvent = {
                "action": "pause",
                "timeStamp": v1.currentTime,
                "videoUrl": person,
                "nowVideo": "false",
                "check": n
            };
            EventBridge.emitWebEvent(JSON.stringify(readyEvent));
            $(".gemstone-button").click(function () {
                console.log(this.value + " button click");
                var clickEvent = {
                    "type": click,
                    "data": this.value
                };
                EventBridge.emitWebEvent(JSON.stringify(clickEvent));
            });
        }

        function nowVideo() {
            console.log("document ready");
            n = Date.now();
            var readyEvent = {
                "action": "pause",
                "timeStamp": v1.currentTime,
                "videoUrl": person,
                "nowVideo": "true",
                "check": n
            };
            EventBridge.emitWebEvent(JSON.stringify(readyEvent));
            $(".gemstone-button").click(function () {
                console.log(this.value + " button click");
                var clickEvent = {
                    "type": click,
                    "data": this.value
                };
                EventBridge.emitWebEvent(JSON.stringify(clickEvent));
            });
        }

        EventBridge.scriptEventReceived.connect(function (message) {

            var messageData = JSON.parse(message);
            action = (JSON.stringify(messageData.action));
            document.getElementById('v1').currentTime = (JSON.stringify(messageData.timeStamp));
            nB = n + 500;
            if (messageData.check <= nB) {
            } else {
                if (action.replace(/\"/g, "") == "pause") {
                    document.getElementById('v1').pause();
                    if (messageData.nowVideo == "true") {
                        firstPlay = true;
                        vid.src = messageData.videoUrl;
                        vid.load();
                        person = messageData.videoUrl;
                    }
                } else {
                    document.getElementById('v1').play();
                }
            }
            (JSON.stringify(messageData.action));
        });

        var person = " ";
        var vid = document.getElementById("v1");
        function chooseVideo() {
            person = prompt("Please enter your video url", " ");
            vid.src = person;
            vid.load();
            nowVideo();
        }

        function sync() {
            console.log("document ready");
            n = Date.now();
            var readyEvent = {
                "action": "pause",
                "timeStamp": v1.currentTime,
                "videoUrl": person,
                "nowVideo": "true",
                "check": n
            };
            EventBridge.emitWebEvent(JSON.stringify(readyEvent));
        }

    </script>
</body>

</html>
